# syntax=docker/dockerfile:1.5
FROM nvidia/cuda:12.4.1-devel-ubuntu22.04

# Set noninteractive frontend
ENV DEBIAN_FRONTEND=noninteractive

# Add MongoDB repository
RUN apt-get update && apt-get install -y curl gnupg2 ca-certificates lsb-release \
  && curl -fsSL https://pgp.mongodb.com/server-7.0.asc | gpg --dearmor -o /usr/share/keyrings/mongodb-server.gpg \
  && echo "deb [arch=amd64 signed-by=/usr/share/keyrings/mongodb-server.gpg] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" > /etc/apt/sources.list.d/mongodb-org-7.0.list

# Install developer tools and language stacks
RUN apt-get update && apt-get install -y \
    sudo unzip zip git wget nano software-properties-common \
    build-essential cmake ninja-build pkg-config \
    python3 python3-pip python3-venv \
    php php-cli php-mbstring php-xml php-curl \
    openjdk-17-jdk maven \
    golang \
    clang gcc g++ \
    apt-transport-https \
    dotnet-sdk-7.0 aspnetcore-runtime-7.0 \
    nodejs npm \
    postgresql-client mysql-client \
    redis-tools mongodb-mongosh \
    docker.io docker-compose \
    nvidia-cuda-toolkit \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Yarn (optional for Node.js)
RUN corepack enable

# Add user
ARG USERNAME=devuser
ARG USER_UID=1000
ARG USER_GID=$USER_UID
RUN groupadd --gid $USER_GID $USERNAME \
    && useradd --uid $USER_UID --gid $USER_GID -m $USERNAME -s /bin/bash \
    && echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/$USERNAME \
    && chmod 0440 /etc/sudoers.d/$USERNAME

# Docker-in-Docker support
RUN dockerd & sleep 3 || true

# Set default user
USER $USERNAME
WORKDIR /workspace